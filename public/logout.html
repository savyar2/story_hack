<!DOCTYPE html>
<html>
<head>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Spotify Top Tracks</title>
    <style>
        body { font-family: "Helvetica Neue", sans-serif; margin: 20px;background: #121212;
            color: dimgray;}

        #tracks-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Auto grid */
    gap: 15px;
    margin-top: 20px;
        }
.track {
    padding: 15px;
    border-radius: 10px;
        transition: all 0.2s ease-in-out;
    cursor: pointer;
}

.track:hover {
    transform: scale(1.05);
    background: #282828;
    color: white;
}

/* Track Text */


.artist-name {
    color: #b3b3b3;
    font-size: 14px;
}

.menu {
    padding-right: 100px;
    /*border-right: 2px solid #cccccc;*/
    height: inherit;
    border-radius: 10px;
    background: #ebfcce;
    overflow-y: auto; /* Adds scroll if needed */
}

.menu-two {
    /*border-right: 2px solid #cccccc;*/
    flex: 1;
    height: 200vh;
    border-radius: 10px;
    background: linear-gradient( #d4fa92, white);
    overflow-y: auto; /* Adds scroll if needed */
    padding-left: 100px;
    padding-right: 100px;
    padding-bottom: 100px;
    padding-top: 50px;
    width: 70vw;
}

.grid {
    padding-left: 10px;
}

.track-name {
    color: #2D2D2D; /*both the title and artist name*/
}

.track-name:hover {
    color: #ffffff; /*both the title and artist name*/
}


.artist-name {
    color: #555555;
}

ul p {
  color: #b3b3b3;
  text-decoration: none;
}

ul p:hover, ul p:focus {
    color: #000000;
}

.logout:hover {
    background-color: gray;
    height: 20px;
}
.logout {
    border-radius: 3px;
    padding: 20px;
    color: white;
}

a:visited {
    color: black;
    text-decoration: none;
}

a:hover {
    color: black;
    text-decoration: none;
}

a:active {
    color: black;
    text-decoration: none;
}

a:link {
    color: black;
    text-decoration: none;
}

input {
    height: 40px;
    color: white;
}


.track:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
}

.track:hover .track-name {
    color: white;
}

.track:hover .artist-name {
    color: lightgray;
}
        .license-button {
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .license-button:hover {
            background-color: #889933;
        }
        button {
  background-color: #ffffff;
  color: #000000;
  font-size: 16px;
  font-weight: bold;
  padding: 14px 30px;
  border-radius: 40px;
  cursor: pointer;
  margin-left: 20px;
            align-items: center;
}
button:hover,
button:active,
button:focus {
  background-color: #f2f2f2;
}

.search-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
}

    #search-bar {
    width: 60%;
    padding: 12px 15px;
    border-radius: 30px;
    border: none;
    font-size: 16px;
    background: #282828;
    color: white;
    outline: none;
    display: flex;
    align-items: center;
        margin-bottom: 20px;
}

    .search-container button {
    background: white;
    color: black;
    font-size: 14px;
    padding: 10px 20px;
    border-radius: 30px;
    cursor: pointer;
    margin-left: -50px; /* Overlap input field */
    border: none;
}

.search-container button:hover {
    background: #1db954;
    color: white;
}

.modal {
    display: flex;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.modal button {
    background-color: #1DB954;
    color: white;
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    border-radius: 5px;
}

.modal button:hover {
    background-color: #169b44;
}
    </style>
</head>
<body>
<div style="display: flex; justify-content: center; align-items: inherit;">

    <input type="text" id="search-bar" placeholder="Search for a track"/>
    <div style="padding-left: 10px">
        <button type="button" id="logout-btn">Log Out</button>
    </div>
            <script>
    document.getElementById("logout-btn").addEventListener("click", function () {
        // // Remove the access token
        // localStorage.removeItem("spotify_token");
        //
        // // Redirect to login page (or reload)
        // window.location.href = "/login"; // Change this if you have a different login page

        logout()
    });
</script>
</div>
<div style="display: flex">
    <div class="menu">
    <ul>
            <h2>Categories</h2>
    <p>        <span class="fa fas fa-music" style="padding-right: 10px"></span>Spotify Top Tracks</p>
    <a href="licenses.html"><p><span class="fa fas fa-book"  style="padding-right: 10px"></span>Licenses</p></a>
<!--        <p class="logout" id="logout-btn">Logout</p>-->
<!--        <script>-->
<!--    document.getElementById("logout-btn").addEventListener("click", function () {-->
<!--        // Remove the access token-->
<!--        localStorage.removeItem("spotify_token");-->

<!--        // Redirect to login page (or reload)-->
<!--        window.location.href = "/"; // Change this if you have a different login page-->
<!--    });-->
<!--</script>-->
    </ul>
    </div>
    <div class="grid">
        <div class="menu-two">
<!--<div style="display: flex">-->
<!--                <input type="text" id="search-bar" placeholder="Search for a track..."/>-->
<!--    <div style="padding-left: 10px">-->
<!--            <p class="logout" id="logout-btn" style="padding-left: 10px; margin: 0; cursor: pointer; text-align: center;">Logout</p>-->
<!--    </div>-->
<!--            <script>-->
<!--    document.getElementById("logout-btn").addEventListener("click", function () {-->
<!--        // Remove the access token-->
<!--        localStorage.removeItem("spotify_token");-->

<!--        // Redirect to login page (or reload)-->
<!--        window.location.href = "/logout.html"; // Change this if you have a different login page-->
<!--    });-->
<!--</script>-->
<!--</div>-->
        <div id="tracks-container"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            document.body.innerHTML = '<h1>Error: No access token found</h1>';
        } else {
            const tracksContainer = document.getElementById('tracks-container');
            const searchBar = document.getElementById('search-bar');
            let tracks = []; // Store tracks globally

            fetch('https://api.spotify.com/v1/me/top/tracks?limit=50', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`HTTP error! Status: ${response.status}, Response: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                tracksContainer.innerHTML = '';

                if (!data.items || data.items.length === 0) {
                    tracksContainer.innerHTML = '<p>No tracks found.</p>';
                    return;
                }

         tracks = data.items; // Store tracks in the global variable
        displayTracks(tracks); // Initial render);
            })
            .catch(error => {
                console.error('Error fetching tracks:', error);
                tracksContainer.innerHTML = `<p>Error loading tracks: ${error.message}</p>`;
            });

                    // Function to render tracks
        // Function to render tracks
    function displayTracks(filteredTracks) {
        tracksContainer.innerHTML = ''; // Clear container

        filteredTracks.forEach(track => {
            const trackElement = document.createElement('div');
            trackElement.classList.add('track');
            trackElement.innerHTML = `
                <img src="${track.album.images[0]?.url || ''}" alt="Album Cover" width="100%" style="border-radius: 5px">
                <span class="track-name">${track.name} <br>
                <span class="artist-name">${track.artists.map(a => a.name).join(', ')}</span></span>
            `;

            // Handle click to log metadata
            trackElement.onclick = () => {
                const metadata = {
                    name: track.name,
                    artist: track.artists.map(a => a.name).join(', '),
                    album: track.album.name,
                    release_date: track.album.release_date,
                    duration_ms: track.duration_ms,
                    popularity: track.popularity,
                    spotify_url: track.external_urls.spotify,
                    image_url: track.album.images[0]?.url || '',
                };

                console.log('ðŸŽµ Song Metadata:', metadata);

                // Send to server
                fetch('/log-metadata', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });
            };

            tracksContainer.appendChild(trackElement);
        });
    }

                // Search Functionality
        searchBar.addEventListener('input', (event) => {
            const query = event.target.value.toLowerCase();
            const filteredTracks = tracks.filter(track =>
                track.name.toLowerCase().includes(query) ||
                track.artists.some(artist => artist.name.toLowerCase().includes(query))
            );
            displayTracks(filteredTracks); // Update display
        });


        }
    </script>
    </div>
    </div>
</div>
<!--&lt;!&ndash; Logout Modal &ndash;&gt;-->
<!--<div id="logout-modal" style="-->
<!--    display: none;-->
<!--    position: fixed;-->
<!--    top: 0;-->
<!--    left: 0;-->
<!--    width: 100%;-->
<!--    height: 100%;-->
<!--    background: rgba(0, 0, 0, 0.5);-->
<!--    display: flex;-->
<!--    justify-content: center;-->
<!--    align-items: center;-->
<!--">-->
<!--    <div style="-->
<!--        background: #282828;-->
<!--        padding: 20px;-->
<!--        border-radius: 10px;-->
<!--        text-align: center;-->
<!--        color: white;-->
<!--        width: 300px;-->
<!--    ">-->
<!--        <p>Are you sure you want to log out?</p>-->
<!--        <button onclick="logout()" style="-->
<!--            background: #1db954;-->
<!--            border: none;-->
<!--            color: white;-->
<!--            padding: 10px 20px;-->
<!--            border-radius: 5px;-->
<!--            cursor: pointer;-->
<!--        ">Yes, Log Out</button>-->
<!--        <button onclick="closeModal()" style="-->
<!--            background: gray;-->
<!--            border: none;-->
<!--            color: white;-->
<!--            padding: 10px 20px;-->
<!--            border-radius: 5px;-->
<!--            cursor: pointer;-->
<!--            margin-left: 10px;-->
<!--        ">Cancel</button>-->
<!--    </div>-->
<!--</div>-->

<div id="logout-modal" class="modal">
    <div class="modal-content">
        <h2>Welcome to Spotify Top Tracks</h2>
        <p>You need to sign in to access your top tracks.</p>
        <button onclick="login()">Sign In</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("spotify_token");
        const modal = document.getElementById("logout-modal");
        const content = document.getElementById("tracks-container");

        if (!token) {
            // If no token, show modal and hide content
            modal.style.display = "flex";
            content.style.display = "none";
        } else {
            // If token exists, hide modal and show content
            modal.style.display = "none";
            content.style.display = "block";
        }
    });

    function login() {
        window.location.href = "/login"; // Redirect to authentication
    }

    function logout() {
        localStorage.removeItem("spotify_token"); // Remove access token
        document.getElementById("logout-modal").style.display = "flex"; // Show modal
        document.getElementById("tracks-container").style.display = "none"; // Hide content
    }
</script>


</body>
</html>